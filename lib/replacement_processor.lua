---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 12/21/2020 4:55 PM
---
--- Reference:
--- https://lua-api.factorio.com/latest/LuaSurface.html
--- https://lua-api.factorio.com/latest/Concepts.html#ChunkPositionAndArea
---

local Table = require('__stdlib__/stdlib/utils/table')
local String = require('__stdlib__/stdlib/utils/string')
local Queue = require('__stdlib__/stdlib/misc/queue')
local Game = require('__stdlib__/stdlib/game')

local ErmConfig = require('__enemyracemanager__/lib/global_config')
local ErmForceHelper = require('__enemyracemanager__/lib/helper/force_helper')
local ErmDebugHelper = require('__enemyracemanager__/lib//debug_helper')

local ReplacementProcessor = {}

local race_pick

local replace_structures = function(surface, entity, race_settings)
    local position = entity.position

    local structure_tier = race_settings[race_pick]['current_support_structures_tier']
    local strucutre_base = race_settings[race_pick]['current_command_centers_tier']
    local pick = math.random();

    local base_name = ''
    if pick < 0.125 then
        base_name = strucutre_base[math.random(1, #strucutre_base)]
    else
        base_name = structure_tier[math.random(1, #structure_tier)]
    end

    local new_force_name = 'enemy'
    if race_pick ~= MOD_NAME then
        new_force_name = 'enemy_' .. race_pick
    end

    local name = race_settings[race_pick].race .. '/' .. base_name .. '/' .. race_settings[race_pick].level
    entity.destroy()
    if not surface.can_place_entity({ name = name, force = new_force_name, position = position }) then
        position = surface.find_non_colliding_position(name, position, 32, 2, true)
    end

    if position then
        surface.create_entity({ name = name, force = new_force_name, position = position })
    end
end

local replace_turrets = function(surface, entity, race_settings)
    local position = entity.position
    local turret_tier = race_settings[race_pick]['current_turrets_tier']
    local base_name = turret_tier[math.random(1, #turret_tier)]
    local name = race_settings[race_pick].race .. '/' .. base_name .. '/' .. race_settings[race_pick].level
    local new_force_name = 'enemy'
    if race_pick ~= MOD_NAME then
        new_force_name = 'enemy_' .. race_pick
    end
    entity.destroy()
    if not surface.can_place_entity({ name = name, force = new_force_name, position = position }) then
        position = surface.find_non_colliding_position(name, position, 32, 2, true)
    end

    if position then
        surface.create_entity({ name = name, force = new_force_name, position = position })
    end
end

function ReplacementProcessor.process_chunks(surface, area, race_settings)
    local turrets = Table.filter(surface.find_entities_filtered({ area = area, type = 'turret' }), Game.VALID_FILTER)
    local turret_size = Table.size(turrets)
    if turret_size > 0 then
        Table.each(turrets, function(entity)
            replace_turrets(surface, entity, race_settings)
        end)
    end

    local spawners = Table.filter(surface.find_entities_filtered({ area = area, type = 'unit-spawner' }), Game.VALID_FILTER)
    local spawners_size = Table.size(spawners)
    if spawners_size > 0 then
        Table.each(spawners, function(entity)
            replace_structures(surface, entity, race_settings)
        end)
    end
end

function ReplacementProcessor.rebuild_map(surface, race_settings, target_force_name)
    if surface then
        race_pick = target_force_name
        game.print('Rebuild Map: ' .. target_force_name .. ' on ' .. surface.name)
        for chunk in surface.get_chunks() do
            ReplacementProcessor.process_chunks(surface, chunk.area, race_settings)
        end

        for name, force in pairs(game.forces) do
            if String.find(force.name, 'enemy') then
                force.kill_all_units()
            end
        end
    end
end

function ReplacementProcessor.replace_entity(surface, entity, race_settings, target_force_name)
    if surface then
        race_pick = ErmForceHelper.extract_race_name_from(target_force_name)
        local nameToken = ErmForceHelper.getNameToken(entity.name)

        if (race_pick == nameToken[1]) then
            return
        end

        if (entity.type == 'unit-spawner') then
            replace_structures(surface, entity, race_settings)
        elseif (entity.type == 'turret') then
            replace_turrets(surface, entity, race_settings)
        end
    end
end

function ReplacementProcessor.resetDefault(surface)
    local spawners = Table.filter(surface.find_entities_filtered({ type = 'unit-spawner' }), Game.VALID_FILTER)
    local spawners_size = Table.size(spawners)
    local spawner_names = { 'spitter-spawner', 'biter-spawner' }
    if spawners_size > 0 then
        Table.each(spawners, function(entity)
            local position = entity.position
            local name = spawner_names[math.random(1, 2)]
            entity.destroy()
            surface.create_entity({ name = name, position = position, force = 'enemy' })
        end)
    end

    local turrets = Table.filter(surface.find_entities_filtered({ type = 'turret' }), Game.VALID_FILTER)
    local turret_size = Table.size(turrets)
    local turret_names = { 'big-worm-turret', 'behemoth-worm-turret' }
    if turret_size > 0 then
        Table.each(turrets, function(entity)
            local position = entity.position
            local name = turret_names[math.random(1, 2)]
            entity.destroy()
            surface.create_entity({ name = name, position = position, force = 'enemy' })
        end)
    end

    for name, force in pairs(game.forces) do
        if String.find(force.name, 'enemy') then
            force.kill_all_units()
        end
    end
end

return ReplacementProcessor