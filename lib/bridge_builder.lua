---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 11/17/2025 5:12 PM
---

local Position = require('__erm_libs__/stdlib/position')
local Cron = require("__enemyracemanager__/lib/cron_processor")
local BridgeBuilder = {}

local spawn_tile = "sand-1"
if script.active_mods["alien-biomes"] then
    spawn_tile = "mineral-brown-sand-1"
end

local planet_tiles = prototypes.mod_data[MOD_DATA_SURFACE_BRIDGE_TILES].data

--- GPT assisted function.
local function queue_landfill_bridge(surface, posA, posB)
    local dx = posB.x - posA.x
    local dy = posB.y - posA.y
    local dist = Position.manhattan_distance(posA, posB)

    -- Normalized forward vector
    local nx = dx / dist
    local ny = dy / dist

    -- Perpendicular vector
    local px = -ny
    local py = nx

    local LONG = 96     
    local HALF_W = 10     -- width = 5 (from -5 .. +5)

    local placed_rows = 0
    local step = 0

    while placed_rows < LONG do
        -- Move forward by integer steps
        local base_x = posA.x + nx * step
        local base_y = posA.y + ny * step
        step = step + 1

        local row_had_water = false
        local positions = {}

        -- Scan width
        for W = -HALF_W, HALF_W do
            local x = base_x + px * W
            local y = base_y + py * W

            local tile = surface.get_tile(x, y)
            if tile.collides_with("water_tile") then
                row_had_water = true
                table.insert(positions, {x, y})
            end
        end

        -- Only queue the row if at least one landfill was placed
        if row_had_water then
            Cron.add_quick_queue("BridgeBuilder.run_cron", surface, positions)
            placed_rows = placed_rows + 1
        end

        -- Safety exit if the direction is not long enough
        if step > dist + 20 then break end
    end
end

function BridgeBuilder.exec(surface, from_position, to_position)
    queue_landfill_bridge(surface, from_position, to_position)
end

function BridgeBuilder.run_cron(surface, positions)
    if surface.valid then
        for _, position in pairs(positions) do
            surface.set_tiles({{
               name = BridgeBuilder.get_tile(surface),
               position = position
           }}, true)
        end        
    end
end

function BridgeBuilder.get_tile(surface)
    if planet_tiles[surface.name] then
        return planet_tiles[surface.name]
    end
    --- Default sand tile
    return spawn_tile
end

return BridgeBuilder