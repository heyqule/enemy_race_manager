---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 7/1/2024 5:42 PM
---

local Config = require('__enemyracemanager__/lib/global_config')
local ForceHelper = require('__enemyracemanager__/lib/helper/force_helper')
local RaceSettingHelper = require('__enemyracemanager__/lib/helper/race_settings_helper')
local AttackGroupProcessor = require('__enemyracemanager__/lib/attack_group_processor')
local BaseBuildProcessor = require('__enemyracemanager__/lib/base_build_processor')

local is_valid = function(event)
    if (Config.environmental_attack_enable() and
        RaceSettingHelper.can_spawn(Config.environmental_attack_raid_chance())) and
        event.surface_index and
        event.target_position
    then
        return true
    end

    if TEST_MODE then
        local can_spawn = RaceSettingHelper.can_spawn(Config.environmental_attack_raid_chance())
        if global.test_environmental_attack_can_spawn == 1 then
            can_spawn = true
        elseif global.test_environmental_attack_can_spawn == -1 then
            can_spawn = false
        end
        return can_spawn
    end

    return false
end

local EnvironmentalAttacks = {}

function EnvironmentalAttacks.exec(event)
    local surface = game.surfaces[event.surface_index]
    local target_position = event.target_position

    if is_valid(event) and
       surface and target_position and
       ForceHelper.can_have_enemy_on(surface)
    then
        local spawn_count = Config.environmental_attack_units_count()

        local group = AttackGroupProcessor.generate_simple_group(surface, target_position, spawn_count)

        local can_spawn_home = RaceSettingHelper.can_spawn(Config.environmental_attack_raid_chance())

        if TEST_MODE then
            if global.test_environmental_attack_spawn_home == 1 then
                can_spawn_home = true
            elseif global.test_environmental_attack_spawn_home == -1 then
                can_spawn_home = false
            end
        end

        if can_spawn_home then
            BaseBuildProcessor.build_formation(group)
        else
            AttackGroupProcessor.process_attack_position(group, defines.distraction.by_enemy, true)
            global.erm_unit_groups[group.group_number] = {
                group = group,
                start_position = group.position,
                always_angry = false,
                nearby_retry = 0,
                attack_force = nil,
                created = game.tick,
                is_aerial = false
            }
        end
    end
end

function EnvironmentalAttacks.reset_global()
    global.test_environmental_attack_spawn_home = nil
    global.test_environmental_attack_can_spawn = nil
end

return EnvironmentalAttacks