---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 7/16/2022 2:58 PM
---

require('__stdlib__/stdlib/utils/defines/time')

local StdIs = require('__stdlib__/stdlib/utils/is')
local ErmConfig = require('__enemyracemanager__/lib/global_config')
local ErmForceHelper = require('__enemyracemanager__/lib/helper/force_helper')
local ErmRaceSettingsHelper = require('__enemyracemanager__/lib/helper/race_settings_helper')
local ErmAttackGroupChunkProcessor = require('__enemyracemanager__/lib/attack_group_chunk_processor')
local ErmSurfaceProcessor = require('__enemyracemanager__/lib/surface_processor')
local ErmCron = require('__enemyracemanager__/lib/cron_processor')
local ErmBossGroupProcessor = require('__enemyracemanager__/lib/boss_group_processor')
local ErmBossAttackProcessor = require('__enemyracemanager__/lib/boss_attack_processor')
local ErmBaseBuildProcessor = require('__enemyracemanager__/lib/base_build_processor')

local ErmDebugHelper = require('__enemyracemanager__/lib/debug_helper')

local BossProcessor = {}

-- beam scan up to 100 chunks
local scanLength = 3200
-- 7 chunks
local scanMinLength = 224
local scanRadius = 16

local chunkSize = 32
local spawnRadius = 64
local cleanChunkSize = 8
local maxRetry = 3

local enemy_entities = {'unit-spawner','turret','unit'}
local enemy_buildings = {'unit-spawner','turret'}
local turrets = {'ammo-turret','electric-turret','fluid-turret'}
local indexable_turrets = {'ammo-turret','fluid-turret'}
local beacon_name = 'erm-boss-beacon'

local boss_setting_default = function()
    return {
        entity = nil,
        entity_name = '',
        entity_position = nil,
        surface = nil,
        surface_name = '',
        race_name = '',
        force = nil,
        force_name = '',
        boss_tier = 1,
        flying_only = false,
        spawned_tick = 0,
        despawn_at_tick = 0,
        pathing_entity = nil,
        pathing_entity_checks = 0,
        last_hp_defense_unit = 0, -- T1 defense, see ErmConfig.BOSS_DEFENSE_ATTACKS
        last_hp_artillery = 0, -- T2 defense
        last_hp_spawner = 0, -- T3 defense
        last_hp_superweapon = 0, -- T4 defense
        victory = false,
        high_level_enemy_list = nil,  -- Track all high level enemies, they die when the base destroys.
        loading = false
    }
end

local boss_spawnable_index_default = function()
    return {
        chunks = {},
        size = 0,
        retry = 0
    }
end


local index_boss_spawnable_chunk = function(gunturret, area, usefirst)
    local surface = gunturret.surface
    local spawners = surface.find_entities_filtered {type=enemy_buildings, force=global.boss.force, area=area, limit=50}

    local target_spawner
    local last = #spawners
    if usefirst then
        target_spawner = spawners[1]
    else
        target_spawner = spawners[last]
    end

    if target_spawner then
        -- Skip if it's too close to any of the turrets
        local turret = surface.find_entities_filtered {position=target_spawner.position, radius=192, type=turrets, limit = 1}
        if turret[1] then
            return
        end
        table.insert(global.boss_spawnable_index.chunks, target_spawner.position)
        global.boss_spawnable_index.size = global.boss_spawnable_index.size + 1
    end
end

local start_unit_spawn = function()
    ErmCron.add_15_sec_queue('BossProcessor.units_spawn')
    ErmCron.add_1_min_queue('BossProcessor.support_structures_spawn')
    ErmCron.add_15_sec_queue('BossGroupProcessor.process_attack_groups')
    ErmBossGroupProcessor.spawn_initial_group()
end

local boss_spawnable_index_switch = {
    [tostring(defines.direction.north)] = function(gunturret)
        local area = {left_top = {gunturret.position.x - scanRadius, gunturret.position.y - scanLength}, right_bottom = {gunturret.position.x + scanRadius, gunturret.position.y - scanMinLength}}
        index_boss_spawnable_chunk(gunturret, area)
    end,
    [tostring(defines.direction.east)] = function(gunturret)
        local area = {left_top = {gunturret.position.x + scanMinLength, gunturret.position.y - scanRadius}, right_bottom = {gunturret.position.x + scanLength, gunturret.position.y + scanRadius}}
        index_boss_spawnable_chunk(gunturret, area, true)
    end,
    [tostring(defines.direction.south)] = function(gunturret)
        local area = {left_top = {gunturret.position.x - scanRadius, gunturret.position.y + scanMinLength}, right_bottom = {gunturret.position.x + scanRadius, gunturret.position.y + scanLength}}
        index_boss_spawnable_chunk(gunturret, area, true)
    end,
    [tostring(defines.direction.west)] = function(gunturret)
        local area = {left_top = {gunturret.position.x - scanLength, gunturret.position.y - scanRadius}, right_bottom = {gunturret.position.x - scanMinLength, gunturret.position.y + scanRadius}}
        index_boss_spawnable_chunk(gunturret, area)
    end,
}

local spawn_building = function()
    for i = 1, ErmConfig.BOSS_SPAWN_SUPPORT_STRUCTURES[ErmRaceSettingsHelper.boss_tier(global.boss.race_name)] do
        local building_name
        if ErmRaceSettingsHelper.can_spawn(10) then
            building_name = ErmBaseBuildProcessor.getBuildingName(global.boss.race_name, 'cc')
        elseif ErmRaceSettingsHelper.can_spawn(50) then
            building_name = ErmBaseBuildProcessor.getBuildingName(global.boss.race_name, 'support')
        else
            building_name = ErmBaseBuildProcessor.getBuildingName(global.boss.race_name, 'turret')
        end
        ErmBaseBuildProcessor.build(global.boss.surface, building_name, global.boss.force_name, global.boss.entity_position)
    end
end

local destroy_beacons = function()
    local beacons = global.boss.surface.find_entities_filtered {name=beacon_name}
    for i=1,#beacons do
        beacons[i].destroy()
    end
end

local unset_boss_data = function()
    global.boss = boss_setting_default()
    -- Kill all attack groups and its units
    global.boss_attack_groups = {}
    -- Kill all defense groups and its units
    global.boss_group_spawn = ErmBossGroupProcessor.get_default_data()
    global.boss_spawnable_index = boss_spawnable_index_default()
end

function BossProcessor.init_globals()
    global.boss = global.boss or boss_setting_default()
    global.boss_attack_groups = global.boss_attack_groups or {}
    global.boss_group_spawn = global.boss_group_spawn or ErmBossGroupProcessor.get_default_data()
    global.boss_spawnable_index = global.boss_spawnable_index or boss_spawnable_index_default()
end

--- Start the boss spawn flow
function BossProcessor.exec(rocket_silo, spawn_position)
    ErmDebugHelper.print('BossProcessor: Check rocket_silo valid...')
    if rocket_silo and rocket_silo.valid and global.boss.loading == false and global.boss.entity == nil then
        global.boss.loading = true
        local surface = rocket_silo.surface
        local race_name = ErmSurfaceProcessor.get_enemy_on(rocket_silo.surface.name)
        local force = game.forces[ErmForceHelper.get_force_name_from(race_name)]
        ErmDebugHelper.print('BossProcessor: Data setup...')
        global.boss.race_name = race_name
        global.boss.force = force
        global.boss.force_name = force.name
        global.boss.surface = surface
        global.boss.surface_name = surface.name
        global.boss.spawned_tick = game.tick
        global.boss.despawn_at_tick = game.tick + (defines.time.minute * ErmConfig.BOSS_DESPAWN_TIMER[global.boss.boss_tier])
        BossProcessor.index_ammo_turret(surface)
        ErmDebugHelper.print('BossProcessor: Indexed positions: '..global.boss_spawnable_index.size)

        if global.boss_spawnable_index.size == 0 and spawn_position == nil then
            surface.print('Unable to find location to spawn a boss')
            return
        end

        if not StdIs.position(spawn_position) then
            spawn_position = global.boss_spawnable_index.chunks[math.random(1, global.boss_spawnable_index.size)]
        end

        local entities = surface.find_entities_filtered {
            type = enemy_entities,
            area = {
                top_left={spawn_position.x - cleanChunkSize, spawn_position.y - cleanChunkSize},
                bottom_right={spawn_position.x + cleanChunkSize, spawn_position.y + cleanChunkSize}
            }
        }
        ErmDebugHelper.print('BossProcessor: To destroy entities: '..#entities)
        for i = 1, #entities do
            entities[i].destroy()
        end

        ErmDebugHelper.print('BossProcessor: Creating Boss Base...')
        ErmDebugHelper.print(BossProcessor.get_boss_name(race_name))
        local boss_entity = surface.create_entity {
            name=BossProcessor.get_boss_name(race_name),
            position=spawn_position,
            force=force
        }

        for _, value in pairs(ErmForceHelper.get_player_forces()) do
            local boss_beacon_entity = surface.create_entity {
                name=beacon_name,
                position=spawn_position,
                force=value.name
            }
            boss_beacon_entity.destructible = false
        end

        ErmDebugHelper.print('BossProcessor: Assign Entities...')
        global.boss.entity = boss_entity
        global.boss.last_hp_defense_unit = boss_entity.health
        global.boss.last_hp_artillery = boss_entity.health
        global.boss.last_hp_spawner = boss_entity.health
        global.boss.last_hp_superweapon = boss_entity.health
        global.boss.entity_name = boss_entity.name
        global.boss.entity_position = boss_entity.position

        game.print({
            'description.boss-base-spawn-at',
            ErmSurfaceProcessor.get_gps_message(
                spawn_position.x,
                spawn_position.y,
                surface.name
            )
        })

        ErmDebugHelper.print('BossProcessor: Create Pathing Unit...')
        local pathing_entity_name = BossProcessor.get_pathing_entity_name(race_name)
        local pathing_spawn_location = surface.find_non_colliding_position(pathing_entity_name, spawn_position, chunkSize, 2, true)
        local pathing_entity = surface.create_entity {
            name=pathing_entity_name,
            position=pathing_spawn_location,
            force=force
        }
        local command = {
            type = defines.command.attack,
            target = rocket_silo,
            distraction = defines.distraction.by_damage
        }
        pathing_entity.set_command(command)
        global.boss.pathing_entity = pathing_entity
        ErmCron.add_2_sec_queue('BossProcessor.check_pathing')
        ErmCron.add_2_sec_queue('BossProcessor.heartbeat')
    end
end

function BossProcessor.check_pathing()
    if global.boss.pathing_entity_checks == 5 then
        local pathing_entity = global.boss.pathing_entity
        ErmDebugHelper.print('BossProcessor: Comparing path unit position')
        if pathing_entity and pathing_entity.valid then
            if pathing_entity.spawner then
                ErmDebugHelper.print('BossProcessor: flying only [attached spawner]')
                global.boss.flying_only = true
                start_unit_spawn()
                global.boss.loading = false
                return
            end

            local boss_base = pathing_entity.surface.find_entities_filtered {name=global.boss.entity_name, position=pathing_entity.position, radius=chunkSize/2}
            if boss_base and boss_base[1] then
                ErmDebugHelper.print('BossProcessor: flying only [unit proximity]')
                ErmDebugHelper.print(#boss_base)
                ErmDebugHelper.print(boss_base[1].name)
                global.boss.flying_only = true
                start_unit_spawn()
                global.boss.loading = false
                return
            end
        end
        ErmDebugHelper.print('BossProcessor: Not a flying only boss ')
        start_unit_spawn()
        global.boss.loading = false
        return
    end

    ErmDebugHelper.print('BossProcessor: Waiting to check path unit')
    global.boss.pathing_entity_checks = global.boss.pathing_entity_checks + 1
    ErmCron.add_2_sec_queue('BossProcessor.check_pathing')
end

function BossProcessor.get_boss_name(race_name)
    return ErmRaceSettingsHelper.get_race_entity_name(
            race_name,
            global.race_settings[race_name].boss_building,
            ErmConfig.BOSS_LEVELS[global.race_settings[race_name].boss_tier]
    )
end

function BossProcessor.get_pathing_entity_name(race_name)
    return ErmRaceSettingsHelper.get_race_entity_name(
            race_name,
            global.race_settings[race_name].pathing_unit,
            global.race_settings[race_name].level
    )
end

function BossProcessor.heartbeat()
    if global.boss.victory then
        -- start reward process
        destroy_beacons()
        ErmDebugHelper.print('BossProcessor: is victory')
        ErmDebugHelper.print('BossProcessor: Heartbeat stops')
        return
    end

    if game.tick > global.boss.despawn_at_tick then
        -- start despawn process
        BossProcessor.unset()
        ErmDebugHelper.print('BossProcessor: start despawn process')
        ErmDebugHelper.print('BossProcessor: Heartbeat stops')
        return
    end

    if not ErmRaceSettingsHelper.is_in_boss_mode() then
        destroy_beacons()
        unset_boss_data()
        ErmDebugHelper.print('BossProcessor: No longer in boss mode')
        ErmDebugHelper.print('BossProcessor: Heartbeat stops')
        return
    end


    if global.boss.last_hp_defense_unit - global.boss.entity.health > ErmConfig.BOSS_DEFENSE_ATTACKS[1] then
        global.boss.last_hp_defense_unit = global.boss.entity.health
        ErmDebugHelper.print('BossProcessor: Base Defense Attack'..global.boss.entity.health)
        ErmBossAttackProcessor.exec_basic()
    end

    if global.boss.last_hp_artillery - global.boss.entity.health > ErmConfig.BOSS_DEFENSE_ATTACKS[2] then
        global.boss.last_hp_artillery = global.boss.entity.health
        ErmDebugHelper.print('BossProcessor: Spawning Defense Unit'..global.boss.entity.health)
        ErmBossGroupProcessor.spawn_defense_group()
    end

    if global.boss.last_hp_spawner - global.boss.entity.health > ErmConfig.BOSS_DEFENSE_ATTACKS[3] then
        global.boss.last_hp_spawner = global.boss.entity.health
        if ErmRaceSettingsHelper.can_spawn(80) then
            ErmDebugHelper.print('BossProcessor: Building Defense Spawner'..global.boss.entity.health)
            spawn_building()
        end
        ErmDebugHelper.print('BossProcessor: Spawn T2 attack'..global.boss.entity.health)
        ErmBossAttackProcessor.exec_advanced()
    end

    if global.boss.last_hp_superweapon - global.boss.entity.health > ErmConfig.BOSS_DEFENSE_ATTACKS[4] then
        global.boss.last_hp_superweapon = global.boss.entity.health
        ErmDebugHelper.print('BossProcessor: Super Attack, '..global.boss.entity.health)
        ErmBossAttackProcessor.exec_super()
    end

    ErmCron.add_2_sec_queue('BossProcessor.heartbeat')
end

function BossProcessor.index_ammo_turret(surface)
    local gunturrets = surface.find_entities_filtered({type=indexable_turrets})
    local totalturrets = #gunturrets;
    local turret_gap = math.max(4,  math.floor(totalturrets / 64))
    local turret_gap_pick = math.max(2, math.random(2, math.floor(turret_gap / 2)))
    ErmDebugHelper.print('BossProcessor: Total: '..totalturrets)
    ErmDebugHelper.print('BossProcessor: Gap: '..turret_gap..'/'..turret_gap_pick)
    for i=1, #gunturrets do
        if i%turret_gap == turret_gap_pick then
            boss_spawnable_index_switch[tostring(gunturrets[i].direction)](gunturrets[i])
            i = i + turret_gap - 2
        end
    end
end

function BossProcessor.units_spawn()
    if not ErmRaceSettingsHelper.is_in_boss_mode() then
        return
    end

    ErmBossGroupProcessor.spawn_regular_group()
    ErmCron.add_15_sec_queue('BossProcessor.units_spawn')
end

function BossProcessor.support_structures_spawn()
    if not ErmRaceSettingsHelper.is_in_boss_mode() then
        return
    end

    local nearby_buildings = global.boss.surface.find_entities_filtered({type=enemy_buildings, force=global.boss.force})
    if #nearby_buildings < ErmConfig.BOSS_MAX_SUPPORT_STRUCTURES[global.race_settings[global.boss.race_name].boss_tier] then
        spawn_building()
    end
    ErmCron.add_1_min_queue('BossProcessor.support_structures_spawn')
end

function BossProcessor.unset()
    if ErmRaceSettingsHelper.is_in_boss_mode() then
        global.boss.entity.destroy()
        destroy_beacons()
        unset_boss_data()
        ErmDebugHelper.print('BossProcessor: Reset...')
    end
end


return BossProcessor