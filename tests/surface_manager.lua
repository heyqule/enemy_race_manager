---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 1/7/2024 2:39 PM
---

local SurfaceProcessor = require('lib/surface_processor')
local TestShared = require('shared')



before_each(function()
    TestShared.prepare_the_factory()
end)

after_each(function()
    TestShared.reset_the_factory()
end)


describe("Surfaces Manager", function()
    it("Add and remove surface", function()
        local new_surface_name = 'testsurface2'
        game.create_surface(new_surface_name)
        assert.not_nil(global.enemy_surfaces[new_surface_name],'New race assigned to new surface')

        local rejected_surface_name = 'Vault 1'
        game.create_surface(rejected_surface_name)
        assert.is_nil(global.enemy_surfaces[rejected_surface_name],'New race not assigned to unsupported surfaces')

        local rejected_surface_name2 = 'aai-signals'
        game.create_surface(rejected_surface_name2)
        assert.is_nil(global.enemy_surfaces[rejected_surface_name2],'R2: New race not assigned to unsupported surfaces')

        game.delete_surface(new_surface_name)
        game.delete_surface(rejected_surface_name)
        game.delete_surface(rejected_surface_name2)
        after_ticks(60, function()
            assert.is_nil(global.enemy_surfaces[new_surface_name],'Removed new race from surface')
        end)
    end)

    ticks_between_tests(60)
    it("Reindex Surfaces", function()
        local surface_count = 10
        for i = 0, surface_count, 1 do
            local new_surface_name = 'testsurface'..tostring(i)
            game.create_surface(new_surface_name)
        end

        local old_list = table.deepcopy(global.enemy_surfaces)
        global.enemy_surfaces = {}
        SurfaceProcessor.rebuild_race()
        local new_list = table.deepcopy(global.enemy_surfaces)
        assert.not_equal(old_list, new_list, 'Both list should not be equal')
        print(serpent.block(old_list))
        print(serpent.block(new_list))
        for i = 0, surface_count, 1 do
            local new_surface_name = 'testsurface'..tostring(i)
            game.delete_surface(new_surface_name)
        end

    end)
end)