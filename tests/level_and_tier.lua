---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 1/6/2024 5:02 PM
---

local LevelManager = require("__enemyracemanager__/lib/level_processor")
local TestShared = require("shared")
local Queue = require("__stdlib__/stdlib/misc/queue")

before_each(function()
    TestShared.prepare_the_factory()
end)

after_each(function()
    TestShared.reset_the_factory()
end)


    it("calculate_levels and calculateMutlipleLevels", function()
        storage.race_settings["erm_vanilla"].evolution_base_point = 2
        LevelManager.calculate_levels()
        assert(storage.race_settings["erm_vanilla"].level == 2, "Level == 2")

        storage.race_settings["erm_vanilla"].evolution_base_point = 10
        LevelManager.calculate_levels()
        assert(storage.race_settings["erm_vanilla"].level == 3, "Level == 3")

        storage.race_settings["erm_vanilla"].evolution_base_point = 50
        LevelManager.calculate_multiple_levels()
        assert(storage.race_settings["erm_vanilla"].level == 10, "Level == 10")
    end)

    it("Test enemy level update", function()
        local surface = game.surfaces[1]
        local enemy_force = game.forces["enemy"]
        local overlord = surface.create_entity({ name = "erm_vanilla--biter-spawner--1", force = enemy_force, position = { 10, 10 } })
        storage.race_settings["erm_vanilla"].evolution_base_point = 50
        LevelManager.calculate_multiple_levels()

        after_ticks(2, function()
            assert(storage.race_settings["erm_vanilla"].level == 10, "Level == 10")
            assert( table_size(storage.mapproc_chunk_queue) > 0, "Has map queue")
        end)

        after_ticks(1800, function()
            local entities = surface.find_entities_filtered({
                type="unit-spawner",
                force="enemy"
            })
            assert.equal("erm_vanilla--biter-spawner--10",entities[1].name, "Correct updated unit spawner")
        end)
    end)

    it("Tiers switch", function()
        local force = game.forces["enemy"]
        force.set_evolution_factor(0.41)
        LevelManager.calculate_levels()
        assert(storage.race_settings["erm_vanilla"].tier == 2, "Tier == 2")

        force.set_evolution_factor(0.81)
        LevelManager.calculate_levels()
        assert(storage.race_settings["erm_vanilla"].tier == 3, "Tier == 3")
    end)