---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 2/15/2022 10:00 PM
---


require("__enemyracemanager__/global")

local Queue = require("__erm_libs__/stdlib/queue")
local String = require("__erm_libs__/stdlib/string")

local GlobalConfig = require("__enemyracemanager__/lib/global_config")

local ForceHelper = require("__enemyracemanager__/lib/helper/force_helper")
local RaceSettingsHelper = require("__enemyracemanager__/lib/helper/race_settings_helper")
local SurfaceProcessor = require("__enemyracemanager__/lib/surface_processor")

local QualityProcessor = require("__enemyracemanager__/lib/quality_processor")
local AttackGroupProcessor = require("__enemyracemanager__/lib/attack_group_processor")
local AttackGroupHeatProcessor = require("__enemyracemanager__/lib/attack_group_heat_processor")
local AttackGroupBeaconProcessor = require("__enemyracemanager__/lib/attack_group_beacon_processor")
local AttackGroupPathingProcessor = require("__enemyracemanager__/lib/attack_group_pathing_processor")
local InterplanetaryAttacks = require("__enemyracemanager__/lib/interplanetary_attacks")
local SpawnLocationScanner = require("__enemyracemanager__/lib/spawn_location_scanner")

local Cron = require("__enemyracemanager__/lib/cron_processor")

local BossProcessor = require("__enemyracemanager__/lib/boss_processor")
local ArmyPopulationProcessor = require("__enemyracemanager__/lib/army_population_processor")
local ArmyTeleportationProcessor = require("__enemyracemanager__/lib/army_teleportation_processor")
local ArmyDeploymentProcessor = require("__enemyracemanager__/lib/army_deployment_processor")
local EmotionProcessor = require("__enemyracemanager__/lib/emotion_processor")

local GuiContainer = require("__enemyracemanager__/gui/main")

--- script.raise_event doesn't work during on_init?
local emulate_event_raise = function(event_name, event_data)
    local event_function = script.get_event_handler(event_name)
    if event_function then
        event_data['name'] = event_name
        event_data['tick'] = game.tick
        event_data['mod_name'] = "enemyracemanager"
        event_function(event_data)
    end
end

local populations = {
    ["playable-tank"] = 3,
    ["playable-car"] = 2,
}

local refresh_army_data = function()
    -- Register Army Units
    for _, prototype in pairs(prototypes.get_entity_filtered({{filter = "type", type = "unit"}})) do
        local nameToken = String.split(prototype.name, "--")
        if nameToken[1] == MOD_NAME and populations[nameToken[2]] then
            remote.call("enemyracemanager","army_units_register", prototype.name, populations[nameToken[2]]);
        end
    end
end
    

local createRace = function()
    if not prototypes.entity['gleba-spawner'] then
        return
    end
    
    local force = game.forces[GLEBA_FORCE_NAME]
    if not force then
        force = game.create_force(GLEBA_FORCE_NAME)
    end

    force.ai_controllable = true;
    force.disable_research()
    force.friendly_fire = true;

    if settings.startup["enemyracemanager-free-for-all"].value then
        ForceHelper.set_friends(game, GLEBA_FORCE_NAME, false)
    else
        ForceHelper.set_friends(game, GLEBA_FORCE_NAME, true)
    end

    ForceHelper.set_neutral_force(game, GLEBA_FORCE_NAME)
    
end

local addRaceSettings = function()
    local race_settings = remote.call("enemyracemanager", "get_race", FORCE_NAME)
    if race_settings == nil then
        race_settings = {}
    end

    race_settings.race = race_settings.race or FORCE_NAME
    race_settings.tier = race_settings.tier or 1
    race_settings.label = { "gui.label-biters" }
    race_settings.is_primitive = race_settings.is_primitive or false
    race_settings.autoplace_name = race_settings.autoplace_name or AUTOCONTROL_NAME
    race_settings.attack_meter = race_settings.attack_meter or 0
    race_settings.attack_meter_total = race_settings.attack_meter_total or 0
    race_settings.next_attack_threshold = race_settings.next_attack_threshold or 0

    race_settings.units = {
        { "small-spitter", "small-biter", "medium-biter", "defender" },
        { "medium-spitter", "big-biter", "big-spitter", "distractor", "logistic-robot" },
        { "behemoth-spitter", "behemoth-biter", "destroyer", "construction-robot" },
    }
    race_settings.turrets = {
        { "medium-worm-turret" },
        { "big-worm-turret" },
        { "behemoth-worm-turret" },
    }
    race_settings.command_centers = {
        { "spitter-spawner", "biter-spawner" },
        { "roboport" },
        {}
    }
    race_settings.support_structures = {
        { "spitter-spawner", "biter-spawner" },
        { "roboport" },
        {},
    }
    race_settings.flying_units = {
        { "defender" },
        { "distractor", "logistic-robot" },
        { "destroyer" },
    }
    race_settings.dropship = "logistic-robot"
    race_settings.droppable_units = {
        { {  "medium-spitter", "medium-biter", "defender" }, { 1, 2, 1 } },
        { { "big-spitter", "big-biter", "defender", "distractor" }, { 2, 3, 1, 1 } },
        { { "big-spitter", "big-biter","behemoth-spitter", "behemoth-biter", "distractor", "destroyer" }, { 2, 3, 1, 2, 1, 1 } },
    }
    race_settings.construction_buildings = {
        { { "biter-spawner", "spitter-spawner" }, { 1, 1 } },
        { { "biter-spawner", "spitter-spawner", "short-range-big-worm-turret" }, { 1, 1, 1 } },
        { { "biter-spawner", "spitter-spawner", "roboport", "short-range-big-worm-turret" }, { 1, 1, 1, 2 } }
    }
    race_settings.featured_groups = {
        --Unit list, spawn percentage, unit_cost
        { { "behemoth-biter", "behemoth-spitter" }, { 5, 2 }, 30 },
        { { "behemoth-spitter", "behemoth-biter" }, { 5, 2 }, 30 },
        { { "big-spitter", "big-biter", "behemoth-spitter", "behemoth-biter" }, { 2, 1, 2, 1 }, 20 },
        { { "big-spitter", "big-biter", "behemoth-spitter", "behemoth-biter" }, { 1, 2, 1, 2 }, 20 },
        { { "defender", "distractor", "destroyer", "behemoth-spitter", "behemoth-biter" }, { 2, 1, 1, 2, 2 }, 25 },
    }
    
    race_settings.featured_flying_groups = {
        { { "distractor", "destroyer" }, { 1, 1 }, 75 },
        { { "defender", "distractor", "destroyer" }, { 3, 1, 1 }, 75 },
        { { "logistic-robot", "defender", "distractor", "destroyer" }, { 1, 2, 2, 1 }, 75 },
    }

    race_settings.interplanetary_attack_active = race_settings.interplanetary_attack_active or false
    
    race_settings.structure_killed_count_by_planet = race_settings.structure_killed_count_by_planet or {}
    race_settings.unit_killed_count_by_planet = race_settings.unit_killed_count_by_planet or {}


    RaceSettingsHelper.process_unit_spawn_rate_cache(race_settings)

    remote.call("enemyracemanager", "register_race", race_settings)

    emulate_event_raise(
            GlobalConfig.custom_event_handlers[GlobalConfig.EVENT_RACE_SETTING_UPDATE],
            {affected_race = FORCE_NAME}
    )

    if prototypes.entity['gleba-spawner'] then
        local gleba_race_settings = remote.call("enemyracemanager", "get_race", GLEBA_FORCE_NAME)
        if gleba_race_settings == nil then
            gleba_race_settings = {}
        end

        gleba_race_settings.race = gleba_race_settings.race or GLEBA_FORCE_NAME
        gleba_race_settings.tier = gleba_race_settings.tier or 1
        gleba_race_settings.is_primitive = true
        gleba_race_settings.autoplace_name = gleba_race_settings.autoplace_name or GLEBA_FORCE_AUTOCONTROL_NAME
        gleba_race_settings.label = { "gui.label-pentapod" }
        gleba_race_settings.attack_meter = gleba_race_settings.attack_meter or 0
        gleba_race_settings.attack_meter_total = gleba_race_settings.attack_meter_total or 0
        gleba_race_settings.next_attack_threshold = gleba_race_settings.next_attack_threshold or 0
        gleba_race_settings.interplanetary_attack_active = gleba_race_settings.interplanetary_attack_active or false
        gleba_race_settings.structure_killed_count_by_planet = gleba_race_settings.structure_killed_count_by_planet or {}
        gleba_race_settings.unit_killed_count_by_planet = gleba_race_settings.unit_killed_count_by_planet or {}

        remote.call("enemyracemanager", "register_race", gleba_race_settings)

        RaceSettingsHelper.process_unit_spawn_rate_cache(gleba_race_settings)

        emulate_event_raise(
                GlobalConfig.custom_event_handlers[GlobalConfig.EVENT_RACE_SETTING_UPDATE],
                {affected_race = GLEBA_FORCE_NAME }
        )        
    end
end

local prepare_world = function()
    GlobalConfig.initialize_races_data()

    -- Game map settings
    game.map_settings.unit_group.max_gathering_unit_groups = settings.global["enemyracemanager-max-gathering-groups"].value
    game.map_settings.unit_group.max_unit_group_size = settings.global["enemyracemanager-max-group-size"].value
    game.map_settings.unit_group.max_member_speedup_when_behind = 2
    game.map_settings.unit_group.max_member_slowdown_when_ahead = 1
    game.map_settings.unit_group.max_group_slowdown_factor = 1
    game.map_settings.unit_group.member_disown_distance = 64
    game.map_settings.unit_group.max_wait_time_for_late_members = 5 * minute
    -- One to two nauvis day of gathering time.
    game.map_settings.unit_group.min_group_gathering_time = 7 * minute
    game.map_settings.unit_group.max_group_gathering_time = 14 * minute
    -- Fresh technology effects
    for _, force in pairs(game.forces) do
        force.reset_technology_effects()
    end

    -- Race Cleanup
    RaceSettingsHelper.clean_up_race()
    SurfaceProcessor.rebuild_race()
    
    refresh_army_data()
    
    AttackGroupBeaconProcessor.init_index()
    SurfaceProcessor.wander_unit_clean_up()
    -- See zerm_postprocess for additional post-process after race_mods loaded

    emulate_event_raise(
            GlobalConfig.custom_event_handlers[GlobalConfig.EVENT_PREPARE_WORLD],
            {  success = true }
    )
end

local conditional_events = function()
    if storage.army_teleporter_event_running or ArmyTeleportationProcessor.can_start_event() then
        ArmyTeleportationProcessor.start_event(true)
    end

    if storage.army_deployer_event_running or ArmyDeploymentProcessor.can_start_event() then
        ArmyDeploymentProcessor.start_event(true)
    end

    if storage.quick_cron_is_running or not Queue.is_empty(storage.quick_cron) then
        script.on_nth_tick(GlobalConfig.QUICK_CRON, Cron.process_quick_queue)
    end

    if storage.boss and storage.boss.entity then
        script.on_nth_tick(GlobalConfig.BOSS_QUEUE_CRON, Cron.process_boss_queue)
    end
end

local init_globals = function()
    -- ID by mod name, each mod should have it own statistic out side of what force tracks.
    storage.race_settings = storage.race_settings or {}

    -- Move all cache to this to resolve desync issues.
    -- https://wiki.factorio.com/Desynchronization
    -- https://wiki.factorio.com/Tutorial:Modding_tutorial/Gangsir#Multiplayer_and_desyncs
    storage.settings = storage.settings or {}

    -- Use for decorative removal when building dies
    storage.decorative_cache = storage.decorative_cache or {}
    
    storage.active_races = {}
    storage.active_races_names = {}
    storage.active_races_num = 1
    storage.remote_race_name_cache = {}
    storage.is_multi_planets_game = false

    --- Space Age OR
    --- by calling remote.call("enemyracemanager", "enable_multi_planet_game") for base game. (see erm_se mod for example)
    if script.active_mods["space-age"] or script.feature_flags.space_travel then
        storage.is_multi_planets_game = true
    end

    if script.active_mods['quality'] then
        storage.is_using_quality = true
    end

    storage.death_loop_detection = storage.death_loop_detection or {}
    storage.compatibility_warnings = false

    SurfaceProcessor.init_globals()
    ForceHelper.init_globals()
    Cron.init_globals()
    AttackGroupProcessor.init_globals()
    AttackGroupBeaconProcessor.init_globals()
    AttackGroupPathingProcessor.init_globals()
    AttackGroupHeatProcessor.init_globals()
    BossProcessor.init_globals()
    ArmyPopulationProcessor.init_globals()
    ArmyTeleportationProcessor.init_globals()
    ArmyDeploymentProcessor.init_globals()
    GuiContainer.init_globals()
    SpawnLocationScanner.init_globals()
    InterplanetaryAttacks.init_globals()
    QualityProcessor.on_init()
    EmotionProcessor.init_globals()

    emulate_event_raise(
        GlobalConfig.custom_event_handlers[GlobalConfig.EVENT_FLUSH_GLOBAL],
{  success = true }
    )
end

--- Init events
local on_init = function(event)
    init_globals()
    GlobalConfig.refresh_config()
    createRace()
    addRaceSettings()
    prepare_world()
    conditional_events()
end

local on_load = function(event)
    Cron.rebuild_queue()
    conditional_events()
end

local on_configuration_changed = function(event)
    init_globals()
    GlobalConfig.refresh_config()
    createRace()
    addRaceSettings()
    prepare_world()
end

---Custom setting processors
local setting_functions = {
    ["enemyracemanager-max-gathering-groups"] = function(event)
        game.map_settings.unit_group.max_gathering_unit_groups = storage.settings[event.setting]
    end,
    ["enemyracemanager-max-group-size"] = function(event)
        game.map_settings.unit_group.max_unit_group_size = storage.settings[event.setting]
    end,
    ["enemyracemanager-army-limit-multiplier"] = function(event)
        for _, force in pairs(game.forces) do
            if ArmyPopulationProcessor.has_army_data(force) then
                ArmyPopulationProcessor.calculate_max_units(force)
            end
        end
    end
}
local on_runtime_mod_setting_changed = function(event)
    if event.setting_type == "runtime-global" and
            string.find(event.setting, "enemyracemanager", 1, true)
    then
        storage.settings[event.setting] = settings.global[event.setting].value

        if setting_functions[event.setting] then
            setting_functions[event.setting](event)
        end
    end
end

local InitController = {}

InitController.events =
{
    [defines.events.on_runtime_mod_setting_changed] = on_runtime_mod_setting_changed
}

InitController.on_configuration_changed = on_configuration_changed

InitController.on_load = on_load

InitController.on_init = on_init

return InitController