---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 6/15/2024 2:10 AM
---

local SharedGuiFunctions = require("__enemyracemanager__/gui/shared")
local ArmyDeploymentProcessor = require("__enemyracemanager__/lib/army_deployment_processor")

local DeployerAttachement = {
    root_name = "erm_deployer_attachment"
}

function DeployerAttachement.show(player, unit_number)
    DeployerAttachement.hide(player)

    local gui = player.gui.relative
    local force_index = player.force.index

    local data = ArmyDeploymentProcessor.get_deployer_data(force_index, unit_number)
    if not data then
        return
    end

    local anchor = {gui=defines.relative_gui_type.assembling_machine_gui, position=defines.relative_gui_position.right}
    local container = gui.add{
        type = "frame",
        name = DeployerAttachement.root_name,
        direction="vertical",
        anchor = anchor,
        -- use gui element tags to store a reference to deployer unit_number
        tags = {
            unit_number = unit_number
        }
    }
    container.style.vertically_stretchable = false

    container.add { type = "label", caption = { "gui-rallypoint.current_location" }, style = "bold_label" }

    if data.rally_point and data.rally_point.x then
        container.add { type = "label", caption = data.rally_point.x .. "," .. data.rally_point.y }
        SharedGuiFunctions.add_mini_map(container,  "erm_rallypoint_map",
                player, data.entity, data.rally_point, 1, { width = 128, height = 128 }, {"gui-rallypoint.map_open"})
    else
        container.add { type = "label", caption = "N/A"}
    end
    container.add { type = "button", name = "erm_rally_point_set", caption = { "gui-rallypoint.set" }, style = "erm_green_button_no_confirm", tooltip=nil}
    container.add { type = "button", name = "erm_rally_point_unset", caption = { "gui-rallypoint.unset" }, style = "red_button"}

    local active_deployers = {}
    if storage.army_active_deployers[force_index] then
        active_deployers = storage.army_active_deployers[force_index]["deployers"]
    end
    container.add { type = "label", caption = {"gui-rallypoint.auto_deploy"} ,style = "bold_label"}
    local switch = container.add {
        type = "switch",
        name = "army_deployer/auto_deploy/" .. data.entity.unit_number,
        tags = {filter_pattern="army_deployer/auto_deploy/.*"},
        allow_none_state = false,
        left_label_caption = "OFF",
        right_label_caption = "ON"
    }
    if active_deployers[unit_number] then
        switch.switch_state = "right"
    end
    
    --- Control Group
    container.add { type = "label", caption = { "gui-unitcontrol.control_group" }, style = "bold_label" }
    --- Show user if there is one.
    local user
    if data.control_group_user then
        user = game.players[data.control_group_user].name
    else
        user = { "gui-unitcontrol.none" }
    end
    container.add { type = "label", caption = {"", {"gui-unitcontrol.current_assigned_player", user}} }

    local control_group_index  
    if data.control_group_index then
        control_group_index = data.control_group_index
    else
        control_group_index = { "gui-unitcontrol.none" }
    end
    container.add { type = "label", caption = {"", {"gui-unitcontrol.current_assigned_group", control_group_index}} }
    --- Update index based on current user
    container.add { type = "label", caption = { "gui-unitcontrol.control_group_index" } }
    local dropdown = container.add{
        type = "drop-down",
        name = "erm_control_group_index_selection",
    }
    dropdown.style.horizontally_stretchable = true
    local index = 1
    dropdown.add_item("---")
    for i =  1,9,1 do
        dropdown.add_item(i)
    end
    dropdown.selected_index = 1
    
    container.add { type = "button", name = "erm_unitcontrol_controlgroup_unset", caption = { "gui-unitcontrol.unset" }, style = "red_button"}
end

function DeployerAttachement.hide(player)
    if player.gui.relative[DeployerAttachement.root_name] then
        player.gui.relative[DeployerAttachement.root_name].destroy()
    end
end

function DeployerAttachement.set_cursor(player)
    player.cursor_stack.set_stack({name = "erm_rally_point"})
end

function DeployerAttachement.remove_rallypoint(player)
    local ui = player.gui.relative[DeployerAttachement.root_name]
    if ui then
        ArmyDeploymentProcessor.remove_rallypoint(player.force.index, ui.tags.unit_number)
        DeployerAttachement.show(player, ui.tags.unit_number)
    end
end

function DeployerAttachement.go_to(player)
    local ui = player.gui.relative[DeployerAttachement.root_name]
    if ui then
        local deployer_data = ArmyDeploymentProcessor.get_deployer_data(player.force.index, ui.tags.unit_number)
        if deployer_data and deployer_data.rally_point then
            player.set_controller {
                type = defines.controllers.remote,
                position = deployer_data.rally_point
            }
        end
    end
end

function DeployerAttachement.set_control_group(player, selected_item)
    local ui = player.gui.relative[DeployerAttachement.root_name]
    if ui then
        local deployer_data = ArmyDeploymentProcessor.get_deployer_data(player.force.index, ui.tags.unit_number)
        if deployer_data then
            ArmyDeploymentProcessor.set_control_group(player, ui.tags.unit_number, selected_item)
            DeployerAttachement.show(player, ui.tags.unit_number)
        end
    end
end

function DeployerAttachement.unset_control_group(player)
    local ui = player.gui.relative[DeployerAttachement.root_name]
    if ui then
        local deployer_data = ArmyDeploymentProcessor.get_deployer_data(player.force.index, ui.tags.unit_number)
        if deployer_data and deployer_data.control_group_user then
            ArmyDeploymentProcessor.unset_control_group(player, ui.tags.unit_number)
            DeployerAttachement.show(player, ui.tags.unit_number)
        end
    end
end

return DeployerAttachement