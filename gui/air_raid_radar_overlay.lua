---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 11/8/2025 12:27 AM
---
local Config = require("__enemyracemanager__/lib/global_config")

local get_render_object_id = rendering.get_object_by_id
local draw_sprite = rendering.draw_sprite
local draw_circle = rendering.draw_circle

local AirRaidRadarOverlay = {}

AirRaidRadarOverlay.init_globals = function()
    -- player_index -> {
    --      array render_object
    -- }
    storage.air_raid_radar_map_data = storage.air_raid_radar_map_data or {}
    storage.air_raid_radars = storage.air_raid_radars or {}
    storage.active_air_raid_radars = storage.active_air_raid_radars or {}
end

local valid_entity = {
    ["erm-air-raid-radar"] = true
}

local function premultiply_with_alpha(color, a)
    color.r = color.r * a
    color.g = color.g * a
    color.b = color.b * a
    color.a = color.a * a
end

local draw_overlay = function(player, entity)
    local radar_map_data = storage.air_raid_radar_map_data
    if not radar_map_data[player.index] then
        radar_map_data[player.index] = {}
    end
    
    if radar_map_data[player.index][entity.unit_number] then
        return
    end
    
    local sprite_render = draw_sprite({
        sprite = "icon-erm_air_raid_radar",
        players= {player},
        x_scale = 5,
        y_scale = 5,
        target = entity.position,
        surface = entity.surface,
        render_mode="chart"
    })
    local circle_render = draw_circle({
        players= {player},
        radius= Config.AIR_RAID_RADAR_RANGE,
        target = entity.position,
        surface = entity.surface,
        filled = true,
        color = {r=0.0, g=0.05, b=0.0, a=0.05},
        render_mode="chart"
    })

    radar_map_data[player.index][entity.unit_number] = {sprite_render.id, circle_render.id}
end

local clear_overlay = function(player)
    local radar_map_data = storage.air_raid_radar_map_data
    if radar_map_data[player.index] then
        for entity_id, entity_renders in pairs(radar_map_data[player.index]) do
            for _, render_id in pairs(entity_renders) do
                local obj = get_render_object_id(render_id)
                if obj then
                    obj.destroy()
                end 
            end
            radar_map_data[player.index][entity_id] = nil
        end
    end
end

local remove_radar_overlay = function(player, entity)
    local radar_map_data = storage.air_raid_radar_map_data
    if radar_map_data[player.index] and radar_map_data[player.index][entity.unit_number] then
        for _, render_id in pairs(radar_map_data[player.index][entity.unit_number]) do
            local obj = get_render_object_id(render_id)
            if obj then
                obj.destroy()
            end
        end
        radar_map_data[player.index][entity.unit_number] = nil
        storage.active_air_raid_radars[entity.unit_number] = nil
    end
end
    

local init_air_raid_radar_list = function(force_index, surface_index)
    local radars = storage.air_raid_radars
    if not radars[force_index] then
        radars[force_index] = {}
    end
    if not radars[force_index][surface_index] then
        radars[force_index][surface_index] = {}
    end
end

AirRaidRadarOverlay.add_radar = function(event)
    local entity = event.entity
    if entity.valid and valid_entity[entity.name] then
        init_air_raid_radar_list(entity.force_index, entity.surface_index)
        storage.air_raid_radars[entity.force_index][entity.surface_index][entity.unit_number] = entity
        local force = entity.force
        for _, player in pairs(force.connected_players) do
            if AirRaidRadarOverlay.is_active(player) then
                draw_overlay(player, entity)    
            end
        end
    end
end

AirRaidRadarOverlay.remove_radar = function(event)
    local entity = event.entity
    if entity.valid and valid_entity[entity.name] then
        if storage.air_raid_radars[entity.force_index][entity.surface_index][entity.unit_number] then
            storage.air_raid_radars[entity.force_index][entity.surface_index][entity.unit_number] = nil
            local force = entity.force
            for _, player in pairs(force.connected_players) do
                remove_radar_overlay(player, entity)
            end
        end
    end
end

AirRaidRadarOverlay.reindex = function()
    local profiler = game.create_profiler()
    --- Clear old data
    local radars = storage.air_raid_radars
    for force_index, force_data in pairs(radars) do
        if game.forces[force_index].valid then
            for surface_index, surface_data in pairs(force_data) do
                if game.surfaces[surface_index].valid then
                    for unit_number, entity in pairs(surface_data) do
                        if not entity.valid then
                            radars[force_index][surface_index][unit_number] = nil
                        end
                    end
                else
                    radars[force_index][surface_index] = nil
                end
            end 
        else
            radars[force_index] = nil
        end
    end

    -- Reindex air raid radars
    for _, surface_data in pairs(game.surfaces) do
        for _, entity in pairs(surface_data.find_entities_filtered{name="erm-air-raid-radar"}) do
            init_air_raid_radar_list(entity.force_index, entity.surface_index)
            if not radars[entity.force_index][entity.surface_index][entity.unit_number] then
                radars[entity.force_index][entity.surface_index][entity.unit_number] = entity
            end
        end
    end

    profiler.stop()
    log({ "", "AirRaidRadarOverlay.reindex: ", profiler })
end

AirRaidRadarOverlay.is_active = function(player)
    local radars_data = storage.air_raid_radar_map_data[player.index]
    return radars_data and next(radars_data)
end

AirRaidRadarOverlay.show = function(player)
    local force_index = player.force_index
    local surface_index = player.surface_index
    if not storage.air_raid_radars[force_index] or not storage.air_raid_radars[force_index][surface_index] then
        return
    end
    local air_raid_radars = storage.air_raid_radars[force_index][surface_index]
    if air_raid_radars then
        for unit_number, entity in pairs(air_raid_radars) do
            if entity.valid then
                draw_overlay(player, entity)
            else
                air_raid_radars[unit_number] = nil
            end
        end
    end
end

AirRaidRadarOverlay.update = function(event)
    local player = game.players[event.player_index]

    if not AirRaidRadarOverlay.is_active(player) then
        return
    end
    
    local surface_index = player.surface_index

    local force_index = player.force.index
    local radars = storage.air_raid_radars[force_index][surface_index]
    if radars and next(radars) then
        for unit_number, entity in pairs(radars) do
            if entity.valid then
                draw_overlay(player, entity)
            else
                radars[unit_number] = nil
            end
        end
    end     
end

AirRaidRadarOverlay.hide = function(player)
    clear_overlay(player)
end

AirRaidRadarOverlay.events = {
    [defines.events.script_raised_revive] = AirRaidRadarOverlay.add_radar,
    [defines.events.script_raised_built] = AirRaidRadarOverlay.add_radar,
    [defines.events.on_built_entity] = AirRaidRadarOverlay.add_radar,
    [defines.events.on_robot_built_entity] = AirRaidRadarOverlay.add_radar,
    [defines.events.on_space_platform_built_entity] = AirRaidRadarOverlay.add_radar,
    
    [defines.events.on_entity_died] = AirRaidRadarOverlay.remove_radar,
    [defines.events.script_raised_destroy] = AirRaidRadarOverlay.remove_radar,
    [defines.events.on_player_mined_entity] = AirRaidRadarOverlay.remove_radar,
    [defines.events.on_robot_mined_entity] = AirRaidRadarOverlay.remove_radar,
    [defines.events.on_space_platform_mined_entity] = AirRaidRadarOverlay.remove_radar,

    [defines.events.on_player_changed_surface] = AirRaidRadarOverlay.update
}

return AirRaidRadarOverlay