---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 11/14/2025 12:04 AM
---

require('util')
local ArmyEconomyHelper = require('__erm_libs__/prototypes/army_economy_helper')

local ERM_UnitHelper = require('__enemyracemanager__/lib/rig/unit_helper')
local ERM_UnitTint = require('__enemyracemanager__/lib/rig/unit_tint')
local ERM_AnimationRig = require('__enemyracemanager__/lib/rig/animation')
local ERM_DebugHelper = require('__enemyracemanager__/lib/debug_helper')
local GlobalConfig = require('__enemyracemanager__/lib/global_config')
local ERMPlayerUnitHelper = require("__enemyracemanager__/lib/rig/player_unit_helper")
local base_sound = require('__base__/prototypes/entity/sounds')

local HumanAnimation = require('__erm_libs__/prototypes/human_animation')
local HumanSound = require('__enemyracemanager_assets__/sound/human_sound')

local human_animation = HumanAnimation.get_animation()
--Level 1 animation, level 2 and 3 are armored animations
-- types: running, running_with_gun, mining_with_tool
local running_animation = human_animation['animations'][2]['running']
ERM_UnitTint.apply_runtime_tint(running_animation['layers'][2])
ERM_UnitTint.apply_runtime_tint(running_animation['layers'][4])
ERM_AnimationRig.adjust_still_frame_all(running_animation['layers'], CHARACTER_RIG_STILL_FRAME)

local gun_animation = human_animation['animations'][2]['idle_with_gun']
ERM_UnitTint.apply_runtime_tint(gun_animation['layers'][2])
ERM_UnitTint.apply_runtime_tint(gun_animation['layers'][4])

local attack_range = 8

local base_movement_speed = 0.1
local incremental_movement_speed = 0.175

-- Misc settings
local vision_distance = ERM_UnitHelper.get_vision_distance(attack_range)

local pollution_to_join_attack = 8
local distraction_cooldown = 30

-- Animation Settings

local collision_box = { { -0.2, -0.2 }, { 0.2, 0.2 } }
local selection_box = { { -0.4, -1.4 }, { 0.4, 0.2 } }
local sticker_box = { { -0.2, -1 }, { 0.2, 0 } }

local mining_animation = human_animation['animations'][1]['mining_with_tool']
ERM_UnitTint.apply_runtime_tint(mining_animation['layers'][2])
local prefix  = "player"
local name = "shotgun_elite"
local icons = {
    {
        icon = "__core__/graphics/icons/entity/character.png",
        icon_size = 64,
        shift = {-2,0}
    },
    {
        icon = "__base__/graphics/icons/combat-shotgun.png",
        icon_size = 64,
        scale = 0.25,
        shift = {-9,9}
    },
}
local resistances = {
    acid = {75},
    poison = {75},
    physical = {75},
    fire = {95, 500},
    explosion = {75},
    laser = {75},
    electric = {75},
    cold = {75}
}

data:extend({
    {
        type = "unit",
        name = prefix.."--controllable--"..name,
        localised_name = { 'entity-name.'..prefix.."--controllable--"..name},
        icons = icons,
        order = prefix.."--controllable--"..name,
        flags = { "placeable-enemy", "placeable-player", "placeable-off-grid", "player-creation", "breaths-air" },
        has_belt_immunity = false,
        max_health = 180 * ERMPlayerUnitHelper.get_health_multiplier(),
        subgroup = "erm_controllable_units",
        shooting_cursor_size = 2,
        resistances = ERMPlayerUnitHelper.get_resistances(resistances),
        map_color = ERM_UnitTint.tint_army_color(),
        healing_per_tick = 0,
        collision_box = collision_box,
        selection_box = selection_box,
        sticker_box = selection_box,
        vision_distance = vision_distance,
        movement_speed = 0.225 * ERMPlayerUnitHelper.get_speed_multiplier(),
        repair_speed_modifier = 0.5,
        distraction_cooldown = distraction_cooldown,
        can_open_gates = true,
        radar_range = 1,
        attack_parameters = {
            type = "projectile",
            ammo_category = "shotgun-shell",
            range = attack_range,
            min_attack_distance = attack_range - 2,
            cooldown = 90,
            damage_modifier = ERMPlayerUnitHelper.get_damage_multiplier() * 1.25,
            shell_particle = {
                name = "shell-particle",
                direction_deviation = 0.1,
                speed = 0.1,
                speed_deviation = 0.03,
                center = { 0, 0.1 },
                creation_distance = -0.5,
                starting_frame_speed = 0.4,
                starting_frame_speed_deviation = 0.1
            },
            projectile_creation_distance = 1.125,
            sound = base_sound.shotgun,
            animation = gun_animation,
            ammo_type = {
                category = "bullet",
                target_type = "direction",
                clamp_position = true,
                action = {
                    {
                        type = "direct",
                        action_delivery = {
                            type = "instant",
                            source_effects = {
                                {
                                    type = "create-explosion",
                                    entity_name = "explosion-gunshot"
                                }
                            }
                        }
                    },
                    {
                        type = "direct",
                        repeat_count = 16,
                        action_delivery = {
                            type = "projectile",
                            projectile = "shotgun-pellet",
                            starting_speed = 1,
                            starting_speed_deviation = 0.1,
                            direction_deviation = 0.3,
                            range_deviation = 0.3,
                            max_range = 20
                        }
                    }
                }
            },
        },
        dying_sound = HumanSound.death(0.5),
        distance_per_frame = 0.1,
        run_animation = running_animation,
        corpse = "common-erm-army-corpse"
    }
})

ArmyEconomyHelper.create_item({
    prefix = prefix,
    name = name,
    icons = icons,
    subgroup = prefix.."--erm_controllable",
    stack_size = 20,
    weight = 50,
})

ArmyEconomyHelper.create_recipe({
    prefix = prefix,
    name = name,
    energy_required = 35,
    ingredients =
    {
        {type = "item", name = "modular-armor", amount = 1},
        {type = "item", name = "combat-shotgun", amount = 1},
        {type = "item", name = "piercing-shotgun-shell", amount = 24},
    },
    category = prefix.."--erm_controllable",
    amount = 1
})

ArmyEconomyHelper.create_deploy_recipe({
    prefix = prefix,
    name = name,
    icons = util.table.deepcopy(icons),
    category = prefix.."--erm_controllable",
})

table.insert(data.raw['technology']['military-3']['effects'],         {
    type = "unlock-recipe",
    recipe = prefix.."--controllable--"..name
})