---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 9/15/2025 7:12 PM
---

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by heyqule.
--- DateTime: 7/3/2021 11:54 PM
---
local sounds = require("__base__.prototypes.entity.sounds")
local item_sounds = require("__base__.prototypes.item_sounds")
require("util")
local biter_ai_settings = require ("__base__.prototypes.entity.biter-ai-settings")
local ERM_UnitHelper = require('__enemyracemanager__/lib/rig/unit_helper')
local ERM_UnitTint = require('__enemyracemanager__/lib/rig/unit_tint')
local ERM_AnimationRig = require('__enemyracemanager__/lib/rig/animation')
local ERMPlayerUnitHelper = require("__enemyracemanager__/lib/rig/player_unit_helper")
local GlobalConfig = require('__enemyracemanager__/lib/global_config')

local ArmyEconomyHelper = require('__erm_libs__/prototypes/army_economy_helper')


local distraction_cooldown = 30

local collision_box = { { -0.5, -0.66 }, { 0.5, 0.66 } }
local selection_box = { { -0.9, -1.3 }, { 0.9, 1.3 } }

local attack_range = ERMPlayerUnitHelper.get_attack_range(1,2)
local vision_distance = ERMPlayerUnitHelper.get_vision_distance(attack_range)

local car = util.table.deepcopy(data.raw['car']['car'])
--Level 1 animation, level 2 and 3 are armored animations
-- types: running, running_with_gun, mining_with_tool
local car_animation = car['animation']
ERM_UnitTint.apply_runtime_tint(car_animation['layers'][2])

local gun_animation = car['turret_animation']
ERM_UnitTint.apply_runtime_tint(car_animation['layers'][2])
ERM_AnimationRig.adjust_repeat_count_all(gun_animation['layers'], 2)
ERM_AnimationRig.adjust_max_advance_all(gun_animation['layers'], 0.2)

local new_animation = {
    layers = {
        car_animation['layers'][1],
        gun_animation['layers'][1],
        car_animation['layers'][2],
        gun_animation['layers'][2],
        car_animation['layers'][3],
        gun_animation['layers'][3],
    }
}

if data.raw['corpse']['erm-player-car-remnants'] == nil then
    local car_corpse = util.table.deepcopy(data.raw['corpse']['car-remnants'])
    car_corpse['name'] = 'erm-player-car-remnants'
    car_corpse['time_before_removed'] = minute * settings.startup["enemyracemanager-enemy-corpse-time"].value / 2
    data:extend({
        car_corpse
    })
end

local prefix  = "player"
local name = "car_rocket"
local icons = {
    {
        icon = "__base__/graphics/icons/car.png",
        icon_size = 64,
    },
    {
        icon = "__base__/graphics/icons/explosive-rocket.png",
        icon_size = 64,
        scale = 0.25,
        shift = {-9,9}
    },
}

local resistances = {
    acid = {75},
    poison = {75},
    physical = {75},
    fire = {75},
    explosion = {75},
    laser = {75},
    electric = {75},
    cold = {75}
}

data:extend({
    {
        type = "unit",
        name = prefix.."--controllable--"..name,
        localised_name = { 'entity-name.'..prefix.."--controllable--"..name},
        icons = icons,
        flags = { "placeable-enemy", "placeable-player", "placeable-off-grid", "not-flammable" },
        has_belt_immunity = true,
        max_health = 150 * ERMPlayerUnitHelper.get_health_multiplier(),
        order = prefix.."--controllable--"..name,
        shooting_cursor_size = 2,
        resistances = ERMPlayerUnitHelper.get_resistances(resistances),
        subgroup = "erm_controllable_units",
        can_open_gates = true,
        map_color = ERM_UnitTint.tint_army_color(),
        healing_per_tick = 0,
        collision_box = collision_box,
        selection_box = selection_box,
        vision_distance = vision_distance,
        radar_range = 1,
        movement_speed = 0.25 * ERMPlayerUnitHelper.get_speed_multiplier(),
        absorptions_to_join_attack = { pollution = 5000},
        distraction_cooldown = distraction_cooldown,
        --ai_settings = biter_ai_settings,
        spawning_time_modifier = 1.5,
        attack_parameters = {
            type = "projectile",
            range_mode = "bounding-box-to-bounding-box",
            ammo_category = "rocket",
            range = attack_range,
            min_attack_distance = attack_range - 4,
            cooldown = 150,
            cooldown_deviation = 0.2,
            damage_modifier = ERMPlayerUnitHelper.get_damage_multiplier(),
            warmup = 6,
            ammo_type = {
                category = "rocket",
                target_type = "direction",
                action = {
                    {
                        type = "direct",
                        action_delivery = {
                            type = "projectile",
                            projectile = "explosive-rocket",
                            starting_speed = 0.3,
                            max_range = GlobalConfig.get_max_projectile_range(),
                        }
                    },
                }
            },
            sound = sounds.heavy_gunshot,
            animation = new_animation,
        },
        distance_per_frame = 1,
        run_animation = new_animation,
        corpse = 'erm-player-car-remnants',
        dying_explosion = "erm-fire-explosion-ground_normal-1",
        light =
        {
            {
                type = "oriented",
                minimum_darkness = 0.3,
                picture =
                {
                    filename = "__core__/graphics/light-cone.png",
                    priority = "extra-high",
                    flags = { "light" },
                    scale = 2,
                    width = 200,
                    height = 200
                },
                shift = {-0.6, -14},
                size = 1.5,
                intensity = 0.4,
                color = {0.92, 0.77, 0.3}
            },
            {
                type = "oriented",
                minimum_darkness = 0.3,
                picture =
                {
                    filename = "__core__/graphics/light-cone.png",
                    priority = "extra-high",
                    flags = { "light" },
                    scale = 2,
                    width = 200,
                    height = 200
                },
                shift = {0.6, -14},
                size = 1.5,
                intensity = 0.4,
                color = {0.92, 0.77, 0.3}
            }
        },
    },
})

ArmyEconomyHelper.create_item({
    prefix = prefix,
    name = name,
    icons = icons,
    subgroup = prefix.."--erm_controllable",
    stack_size = 10,
    weight = 100,
})

ArmyEconomyHelper.create_recipe({
    prefix = prefix,
    name = name,
    energy_required = 40,
    ingredients =
    {
        {type = "item", name = "car", amount = 1},
        {type = "item", name = "low-density-structure", amount = 10},
        {type = "item", name = "explosive-rocket", amount = 24},
        {type = "item", name = "rocket-fuel", amount = 10},
    },
    category = prefix.."--erm_controllable",
    amount = 1
})

ArmyEconomyHelper.create_deploy_recipe({
    prefix = prefix,
    name = name,
    icons = util.table.deepcopy(icons),
    category = prefix.."--erm_controllable",
})

table.insert(data.raw['technology']['explosive-rocketry']['effects'],         {
    type = "unlock-recipe",
    recipe = prefix.."--controllable--"..name
})


